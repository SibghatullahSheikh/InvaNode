<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <title>InvaNode Admin Panel</title>
    <script src="/template/assets/js/jquery.js"></script>
        <script src="/template/assets/js/bootstrap.min.js"></script>
        <script src="/template/assets/js/wysihtml5-0.3.0.min.js"></script>
        <script src="/template/assets/js/bootstrap-wysihtml5-custom.js"></script>
        <script src="/template/assets/js/bootbox.min.js"></script>
        <link rel="stylesheet" type="text/css" href="/template/assets/css/bootstrap-wysihtml5-0.0.2.css" />
        <link type="text/css" rel="stylesheet" media="all" href="/template/assets/css/bootstrap.min.css" />
  
        
        <script src="/template/admin/codemirror/codemirror.js"></script>
        <link rel="stylesheet" href="/template/admin/codemirror/codemirror.css" />
        <script src="/template/admin/codemirror/mode/xml/xml.js"></script>
        <script src="/template/admin/codemirror/mode/javascript/javascript.js"></script>
        <script src="/template/admin/codemirror/mode/css/css.js"></script>
        <script src="/template/admin/codemirror/mode/htmlmixed/htmlmixed.js"></script>
        
  <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      .CodeMirror {
        background-color: #fff; 
      }
      .CodeMirror-scroll {
        height: 650px;
      }
    </style>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
<script>
   var myCodeMirror; 
    String.prototype.replaceAll=function(find, replace_to){
     alert('a');
     return this.replace(new RegExp(find, "g"), replace_to);
};


function getLocalImages()
{   
    var out = '';
    $.post("get_local_images", function(data){
        if(data=="error"){
            out = "Error loading files";
        }
        else
        {    
        data = $.parseJSON(data);
        var i = data.length;
         while(i--)
             {
                out +=  '<div style="float:left; padding: 6px; border: 1px solid #ccc; margin:0 10px 10px 0; cursor:pointer;" onclick="insertLocalImage(\''+data[i]+'\')"><img style="height: 100px; width: auto;" src="/images/'+encodeURI(data[i])+'" /></div>'
               
             }
         out +=  '<div style="float:left; height: 100px; width: 100px; text-align: center; padding: 6px; border: 1px solid #ccc; margin:0 10px 10px 0; cursor:pointer; position:relative;">'+
                 '<input type="file" name="fileBox" id="fileBox" style="opacity: 0; position: absolute; top:0; left:0; width:100%; height:100%; cursor:pointer;" onchange="addNewImage(event)">'+
                 '<span style="font-size: 94px;line-height: 99px; color:#08c;" id="image-load-loader-place">\+</span></div>'    
        $("#local-images-holder").html(out);
        }  
    });
}
function insertLocalImage(fileName)
{
    $("#local-image-url").val("http://"+location.host+'/images/'+encodeURI(fileName));
    
}
    
function addNewImage(event)
{
  $("#image-load-loader-place").html('<img src="/template/assets/img/loading.gif" width: 40px; height: 40px; />');  
  var SelectedFile = event.target.files[0];
  Name = SelectedFile.name;
  Size = SelectedFile.size;
  FReader = new FileReader();   
  FReader.onload = function(evn){  
            $.post("upload_image_file",{'data':evn.target.result, 'name':Name, 'size':Size},function(data){
                    if(data=="error"){alert("somthing went wrong!"); getLocalImages();}
                    else{
                        getLocalImages();
                    }
    });
  }
  FReader.readAsDataURL(SelectedFile)

}
    
    $("document").ready(function(){
       loadAll(window.location.hash.split('#')[1]);
    });
    function loadAll(type)
    {   
        var todo='load_all_'+type;
        $.post('structural_load', {todo:todo}, function(data){
            var toHtml;
            data = $.parseJSON(data);
            if(type!="templates"){
                    toHtml ='<h3 style="float: left; margin-right: 40px;">'+type.charAt(0).toUpperCase()+type.slice(1)+'</h3><div style="margin-top: 15px;"><a class="btn btn-primary" href="#" onclick="addNew(\''+type+'\');return false;"><i class="icon-pencil icon-white"></i> Add new</a></div>';
                    toHtml +='<div class="span15">';
                    toHtml +='<div class="span1" style="min-height:50px;"><h4>ID</h4></div><div class="span7"><h4>Name</h4></div><div class="span3"><h4>Options</h4></div>';
                    toHtml +='<div style="clear:both; border-top: 1px solid #DDD;"></div>';
                    data.forEach(function(line){
                        toHtml +='<div class="span1" style="min-height:50px; margin-top: 14px;">'+line.id+'</div><div class="span7" style="min-height:50px; margin-top: 14px;"><a href="{{SITE_URL}}'+line.alias+'" target="_blank">'+line.name+'</a></div><div class="span3">'+buttonsGroup(type, line.id)+'</div>';
                        toHtml +='<div style="clear:both; border-top: 1px solid #DDD;"></div>';
                    });
                    toHtml +='</div>';
            }
            else{
                    toHtml ='<h3 style="float: left; margin-right: 40px;">'+type.charAt(0).toUpperCase()+type.slice(1)+'</h3><div style="margin-top: 15px;"></div>';
                    toHtml +='<div style="clear:both; border-top: 1px solid #DDD;"></div>';
                    var i = data.length;
                    while(i--){
                        toHtml +='<div class="span1" style="min-height:50px; margin-top: 14px;"></div><div class="span7" style="min-height:50px; margin-top: 14px;">'+data[i]+'</div><div class="span3">'+buttonsGroup(type, data[i])+'</div>';
                        toHtml +='<div style="clear:both; border-top: 1px solid #DDD;"></div>';  
                    }  
            }
            $("#main_canv").html(toHtml)
        });
    }
        
    function buttonsGroup(type, id)
    {
        if(type=='users'){
            return '';
        }
        else if(type=='templates'){
            return '<div class="btn-toolbar"><div class="btn-group"><a class="btn" href="#" onclick="editTemplate(\''+id+'\');return false;"><i class="icon-edit"></i></a></div></div>';
        }
        else{
            return '<div class="btn-toolbar"><div class="btn-group"><a class="btn" href="#" onclick="editPPU(\''+type+'\', '+id+');return false;"><i class="icon-edit"></i></a><a class="btn btn-danger" href="#" onclick="deletePPU(\''+type+'\', '+id+');return false;"><i class="icon-remove"></i></a></div></div>';
        }
    }
    
    function editTemplate(fName)
    {
         $.post("process_template_data",{todo:"get",fname:fName,fdata:"null"},function(data){
          if(data!="error"){
            var toHtml = '<div class="hero-unit"><div style="margin-bottom: 30px;"><h2 style="float: left; margin-right: 40px;">'+fName+'</h2><div style="padding-top: 15px;"><a class="btn btn-primary" href="#" onclick="saveTemplate(\''+fName+'\');return false;"><i class="icon-pencil icon-white"></i> Save</a><a style="margin-left: 10px;" class="btn btn-danger" href="#" onclick="loadAll(\'templates\');return false;"><i class="icon-remove icon-white"></i> Cancel</a></div></div>';
         
            toHtml +='<textarea style="width: 810px; height: 650px; background-color: #fff;" id="editor"></textarea>';
            
            toHtml +='</div>';
            $("#main_canv").html(toHtml);
            $('#editor').val(data);
            myCodeMirror = CodeMirror.fromTextArea(editor);
          }
          else{
              bootbox.alert("Error loading file "+fName);
          }
        });
    }
    function saveTemplate(fName)
    {
        myCodeMirror.save();
        var fdata = $('#editor').val();
         $.post("process_template_data",{todo:"save",fname:fName,fdata:fdata},function(data){
          if(data!="error"){
             bootbox.alert("File <b>"+fName+"</b> saved!", function(){loadAll("templates");});
            }
          else{
              bootbox.alert("Error saving file "+fName);
          }
        });
    }
    
    function addNew(type)
    {   
        var name = '';
        switch(type)
        {
            case "users": name ='New user';
                break;
         case "posts": name = 'New post';
                break;
         case "pages": name = 'New page';
                break;
        }
        
        
        var toHtml = '<div class="hero-unit"><div style="margin-bottom: 30px;"><h2 style="float: left; margin-right: 40px;">'+name+' editor</h2><div style="padding-top: 15px;"><a class="btn btn-primary" href="#" onclick="saveNew(\''+type+'\');return false;"><i class="icon-pencil icon-white"></i> Save</a></div></div>';
         
         toHtml +='<div style="margin-left: 0px;" class="span5"><h4 style="float: left; line-height: 10px; margin-right: 10px;">Name: </h4> <input type="text" class="span4" id="ent_name" onkeyup="trackAlias()" /></div><div class="span5"><h4 style="float: left; line-height: 10px; margin-right: 10px;">Alias: </h4> <input type="text" class="span4" id="ent_alias" /></div><textarea style="width: 810px; height: 400px;" id="editor"></textarea>';
         toHtml +='<div class="span11" style="margin-left:0;"><h4 style="float: left; line-height: 10px; margin-right: 17px;">Description: </h4> <input type="text" value="" class="span9" id="ent_description" /></div>';
         toHtml +='</div>';
            $("#main_canv").html(toHtml);
            $('#editor').wysihtml5({
                "html": true,
                "color": true
            });
    }
    
    function trackAlias()
    {
       var str = $("#ent_name").val();
       $("#ent_alias").val(str.toLowerCase().replace(new RegExp(" ", "g"), "_"));
    }
    
    function saveNew(type)
    {
        
        var name = $("#ent_name").val();
        var alias =  $("#ent_alias").val();
        var text = $('#editor').val();
        var description = $("#ent_description").val();
        $.post('post_page_savings', {name:name,alias:alias,type:type,text:text,description:description},function(data){
           bootbox.alert(data, function() {
                loadAll(type);
            }); 
        });  
    }
    
    function deletePPU(type, id)
    {
        var todo='delete';
        $.post("post_page_editing", {todo:todo, type:type, id:id}, function(data){
          bootbox.alert(data, function() {
                loadAll(type);
            });
        });
    }
    
    function editPPU(type, id)
    {   
        var todo='opendata';
        $.post("post_page_editing", {todo:todo, type:type, id:id}, function(data){
           openEditor(data, type, id); 
        });
    }
    
    function openEditor(data, type, id)
    {   
        
        data = $.parseJSON(data);
        var name = '';
        switch(type)
        {
         case "users": name ='Edit user';
                break;
         case "posts": name = 'Edit post';
                break;
         case "pages": name = 'Edit page';
                break;
        }
        
        
        var toHtml = '<div class="hero-unit"><div style="margin-bottom: 30px;"><h2 style="float: left; margin-right: 40px;">'+name+'</h2><div style="padding-top: 15px;"><a class="btn btn-primary" href="#" onclick="saveEdited(\''+type+'\', '+id+');return false;"><i class="icon-pencil icon-white"></i> Save</a><a style="margin-left: 10px;" class="btn btn-danger" href="#" onclick="loadAll(\''+type+'\');return false;"><i class="icon-remove icon-white"></i> Cancel</a></div></div>';
         
         toHtml +='<div style="margin-left: 0px;" class="span5"><h4 style="float: left; line-height: 10px; margin-right: 10px;">Name: </h4> <input type="text" value="'+data[0].name+'" class="span4" id="ent_name" onkeyup="trackAlias()" /></div><div class="span5"><h4 style="float: left; line-height: 10px; margin-right: 10px;">Alias: </h4> <input type="text" value="'+data[0].alias+'" class="span4" id="ent_alias" /></div><textarea style="width: 810px; height: 400px;" id="editor">'+data[0].smaldata+'--CUT--'+data[0].data+'</textarea>';
         toHtml +='<div class="span11" style="margin-left:0;"><h4 style="float: left; line-height: 10px; margin-right: 17px;">Description: </h4> <input type="text" value="'+data[0].description+'" class="span9" id="ent_description" /></div>';
          
          
          toHtml +='<div data-wysihtml5-dialog="insertImage" style="display: none;">';
   toHtml +='<label>';
        toHtml +='URL: <input data-wysihtml5-dialog-field="src" value="http://">';
      toHtml +='</label>';
      toHtml +='<label>';
        toHtml +='Alternative text: <input data-wysihtml5-dialog-field="alt" value="">';
      toHtml +='</label>';
    toHtml +='</div>';
         
         
         
         toHtml +='</div>';
            $("#main_canv").html(toHtml);
            $('#editor').wysihtml5({
                "html": true,
                "color": true
            });
            
        var dialog = new wysihtml5.toolbar.Dialog(
         document.querySelector("[data-wysihtml5-command='insertImage']"),
         document.querySelector("[data-wysihtml5-dialog='insertImage']")
       );
       dialog.observe("save", function(attributes) {
        alert("ho=o");
       });
            
    }
    
    function saveEdited(type, id)
    {
       var name = $("#ent_name").val();
        var alias =  $("#ent_alias").val();
        var text = $('#editor').val();
        var description = $("#ent_description").val();
        var todo='edit';
        $.post('post_page_editing', {todo:todo,id:id,name:name,alias:alias,type:type,text:text,description:description},function(data){
           bootbox.alert(data, function() {
                loadAll(type);
            }); 
        });  
    }
    
    function reloadTemplate()
    {
        $.post('reload_template_immidiate',function(data){
           bootbox.alert(data); 
        }); 
    }
</script>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="{{SITE_URL}}">{{APPNAME}}</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="#pages" onclick="loadAll('pages');">Pages</a></li>
              <li><a href="#posts" onclick="loadAll('posts');">Posts</a></li>
              <li><a href="#users" onclick="loadAll('users');">Users</a></li>
              <li><a href="#templates" onclick="loadAll('templates');">Templates</a></li>
            </ul>
            <button class="btn btn-inverse" onclick="reloadTemplate()" style="">Reload Template</button>  
             {{USER_MENU}} 
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container" id="main_canv">

      <h1>InvaNode CMS Admin Panel</h1>
      <h3>{{APPNAME}} Statistics</h3>
      <div style="margin-top: 20px;" class="span7">
      <table class="table">
        <thead>
            <tr>
                <th>Statistics</th>
                <th>#</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Number of Pages</td>
                <td>{{NUMBER_OF_PAGES}}</td>
            </tr>
            <tr>
                <td>Number of Posts</td>
                <td>{{NUMBER_OF_POSTS}}</td>
            </tr>
            <tr>
                <td>Number of Users</td>
                <td>{{NUMBER_OF_USERS}}</td>
            </tr>
            <tr>
                <td></td>
                <td></td>
            </tr>
        </tbody>
      </table>    
      </div>    
    </div> <!-- /container -->
</body>
</html>